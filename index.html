<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Budget Tracker</title>
<link rel="manifest" href="manifest.json">
<style>
:root {
  --primary-color: #4CAF50;
  --secondary-color: #f2f2f2;
  --font-color: #333;
  --border-radius: 8px;
  --box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
  background-color: var(--secondary-color);
  margin: 0;
  padding: 1rem;
  color: var(--font-color);
}
.container {
  max-width: 600px;
  margin: 0 auto;
}
h1 {
  text-align: center;
  color: var(--primary-color);
  font-size: 2rem;
}
.add-category-form {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}
.add-category-form input, .add-category-form button {
  font-size: 1rem;
}
.add-category-form input {
  flex-grow: 1;
  padding: 0.8rem;
  border: 1px solid #ccc;
  border-radius: var(--border-radius);
  min-width: 100px;
}
.add-category-form button {
  padding: 0.8rem 1rem;
  background-color: var(--primary-color);
  color: white;
  border: none;
  border-radius: var(--border-radius);
  cursor: pointer;
  transition: background-color 0.3s;
  min-width: 110px;
}
.add-category-form button:hover {
  background-color: #45a049;
}
.action-buttons {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin-bottom: 1.3rem;
  justify-content: center;
}
.action-buttons button {
  padding: 0.6rem 1.3rem;
  background-color: #2196F3;
  color: white;
  border: none;
  border-radius: var(--border-radius);
  cursor: pointer;
  font-size: 1rem;
  box-shadow: var(--box-shadow);
  transition: background 0.3s;
}
.action-buttons button:hover {
  background-color: #1976d2;
}
.category-list {
  min-height: 30px;
}
.category {
  background-color: white;
  padding: 1rem;
  border-radius: var(--border-radius);
  margin-bottom: 1rem;
  box-shadow: var(--box-shadow);
  cursor: grab;
  transition: box-shadow 0.15s, border 0.15s;
  border: 2px solid transparent;
  user-select: none;
  position: relative;
  display: flex;
  flex-direction: column;
}
.category.dragging {
  opacity: 0.75;
  box-shadow: 0 6px 16px rgba(0,0,0,0.15);
  border: 2px dashed var(--primary-color);
  z-index: 10;
}
.category.drag-over {
  border: 2px dashed #1976d2;
}
.category-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
  flex-wrap: wrap;
  gap: 0.5rem;
}
.category-title {
  font-weight: bold;
  font-size: 1.1rem;
  word-break: break-word;
}
.category-budget {
  font-size: 0.9rem;
  color: #666;
}
.progress-bar-container {
  width: 100%;
  background-color: #e0e0e0;
  border-radius: var(--border-radius);
  margin-bottom: 0.5rem;
  height: 18px;
}
.progress-bar {
  height: 100%;
  background-color: var(--primary-color);
  width: 0%;
  border-radius: var(--border-radius);
  transition: width 0.3s ease-in-out;
}
.progress-bar.over-budget {
  background-color: #f44336;
}
.category-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.add-transaction-btn {
  background-color: var(--primary-color);
  color: white;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  font-size: 1.7rem;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  padding-bottom: 4px;
  transition: background 0.3s;
}
.add-transaction-btn:hover {
  background-color: #388e3c;
}
.delete-category-btn {
  background-color: #f44336;
  color: white;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  font-size: 1.2rem;
  cursor: pointer;
  margin-left: 0.3rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.3s;
}
.delete-category-btn:hover {
  background-color: #b71c1c;
}
.move-arrows {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-right: 0.7rem;
  user-select: none;
}
.move-arrow-btn {
  background: #e3eafc;
  color: #1976d2;
  border: none;
  border-radius: 50%;
  width: 28px;
  height: 28px;
  font-size: 1.2rem;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 2px 0;
  cursor: pointer;
  transition: background 0.2s;
  box-shadow: var(--box-shadow);
}
.move-arrow-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}
.move-arrow-btn:hover:enabled {
  background: #bbdefb;
}
.remaining-balance, .overspent, .motivation {
  font-size: 0.96rem;
  margin-top: 2px;
  font-weight: 500;
}
.remaining-balance { color: #388e3c; }
.overspent { color: #c62828; }
.motivation {
  color: #1976d2;
  margin-bottom: 0.5rem;
  font-style: italic;
  display: block;
}

#summary {
  font-size: 1.08rem;
  font-weight: bold;
  color: #333;
  background: #e3eafc;
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
  margin: 1.2rem auto 0 auto;
  padding: 0.7rem 1.1rem;
  max-width: 370px;
  text-align: left;
  display: block;
  letter-spacing: 0.2px;
  border-left: 6px solid #2196F3;
}
#summary span {
  display: block;
  margin-bottom: 2px;
}
#summary .summary-over {
  color: #c62828;
  font-weight: bold;
}
#summary .summary-budget {
  color: #2e7d32;
  font-weight: bold;
}
#summary .summary-spent {
  color: #1976d2;
  font-weight: bold;
}

/* Responsive design */
@media (max-width: 600px) {
  .container {
    padding: 0.5rem;
    max-width: 100%;
  }
  .add-category-form, .action-buttons {
    flex-direction: column;
    gap: 0.8rem;
  }
  .add-category-form input, .add-category-form button, .action-buttons button {
    width: 100%;
    min-width: unset;
  }
  .category-header, .category-footer {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.3rem;
  }
  #summary {
    font-size: 0.98rem;
    max-width: 100%;
    padding: 0.9rem 0.5rem;
  }
  .move-arrows {
    flex-direction: row;
    margin-bottom: 0.5rem;
    margin-right: 0;
    gap: 0.3rem;
  }
  .move-arrow-btn {
    margin: 0 2px 0 0;
  }
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<div class="container">
  <h1>My Budget Tracker</h1>
  <div class="add-category-form">
    <input type="text" id="categoryName" placeholder="Category Name" autocomplete="off">
    <input type="number" id="categoryBudget" placeholder="Budget" min="0" inputmode="decimal">
    <button onclick="addCategory()">Add Category</button>
  </div>
  <div class="action-buttons">
    <button onclick="downloadBudgetData()">Download JSON</button>
    <button onclick="downloadBudgetPDF()">Download PDF</button>
    <button onclick="resetAllBudgets()">Reset Budgets</button>
    <button onclick="removeAllCategories()">Remove All Categories</button>
  </div>
  <div id="categoriesList" class="category-list"></div>
  <div id="summary"></div>
</div>

<script>
const motivationalMessages = [
  "You're doing great! Think before you spend more.",
  "Stay strong – every dollar saved counts!",
  "Remember your goals. Overspending sets you back!",
  "Pause and reflect – can this expense wait?",
  "Success is the sum of small efforts. Keep going!",
  "Discipline now means freedom later. Stick with it!",
  "You're in control of your finances!",
  "Every budget win is a step closer to your dreams!",
  "Overspending is temporary, smart habits last forever!",
  "Resist the urge! You can do this."
];

document.addEventListener('DOMContentLoaded', () => {
  loadBudgetData();
  enableDragAndDrop();
});

function getBudgetData() {
  const budgetDataJSON = localStorage.getItem('budgetTrackerData');
  return budgetDataJSON ? JSON.parse(budgetDataJSON) : [];
}

function saveBudgetData(data) {
  localStorage.setItem('budgetTrackerData', JSON.stringify(data));
}

function loadBudgetData() {
  const budgetData = getBudgetData();
  updateSummary();
  const categoriesList = document.getElementById('categoriesList');
  categoriesList.innerHTML = '';
  budgetData.forEach((category, index) => {
    const categoryElement = createCategoryElement(category, index, budgetData.length);
    categoriesList.appendChild(categoryElement);
    updateProgressBar(index);
  });
  enableDragAndDrop();
}

function addCategory() {
  const categoryNameInput = document.getElementById('categoryName');
  const categoryBudgetInput = document.getElementById('categoryBudget');
  const categoryName = categoryNameInput.value.trim();
  const categoryBudget = parseFloat(categoryBudgetInput.value);

  if (categoryName && !isNaN(categoryBudget) && categoryBudget > 0) {
    const budgetData = getBudgetData();
    budgetData.push({
      name: categoryName,
      budget: categoryBudget,
      spent: 0
    });
    saveBudgetData(budgetData);
    loadBudgetData();
    categoryNameInput.value = '';
    categoryBudgetInput.value = '';
  } else {
    alert('Please enter a valid category name and budget.');
  }
}

function addTransaction(categoryIndex) {
  const budgetData = getBudgetData();
  const category = budgetData[categoryIndex];
  if (!category) return;

  const transactionAmount = prompt('Enter transaction amount:');
  if (transactionAmount === null) return;

  const amount = parseFloat(transactionAmount);
  if (!isNaN(amount) && amount > 0) {
    // prompt for memo (optional)
    let memo = prompt('Add a short memo/description for this transaction (optional):');
    // If user pressed Cancel on memo prompt, set memo to empty string but continue
    if (memo === null) memo = '';

    // Check if this transaction will overspend
    if ((category.spent || 0) + amount > (category.budget || 0)) {
      const randomMsg = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];
      if (!confirm(randomMsg + "\nThis will overspend your budget for this category. Continue anyway?")) {
        return;
      }
    }

    // ensure transactions array exists
    category.transactions = Array.isArray(category.transactions) ? category.transactions : [];
    const transaction = {
      amount: Number(amount),
      memo: memo,
      date: new Date().toISOString()
    };
    category.transactions.push(transaction);
    // recompute spent
    category.spent = category.transactions.reduce((s, t) => s + (Number(t.amount) || 0), 0);

    saveBudgetData(budgetData);
    loadBudgetData();
  } else {
    alert('Please enter a valid amount.');
  }
}

function deleteCategory(index) {
  if (confirm('Are you sure you want to delete this category?')) {
    const budgetData = getBudgetData();
    budgetData.splice(index, 1);
    saveBudgetData(budgetData);
    loadBudgetData();
  }
}
i
function moveCategory(index, direction) {
  const data = getBudgetData();
  if (
    (direction === -1 && index === 0) ||
    (direction === 1 && index === data.length - 1)
  ) return;
  const item = data.splice(index, 1)[0];
  data.splice(index + direction, 0, item);
  saveBudgetData(data);
  loadBudgetData();
}

function createCategoryElement(category, index, total) {
  const element = document.createElement('div');
  element.className = 'category';
  element.draggable = true;
  element.dataset.index = index;
  element.innerHTML = `
    <div style="display: flex; align-items: flex-start;">
      <div class="move-arrows" aria-label="Move category" title="Reorder">
        <button class="move-arrow-btn" aria-label="Move up" title="Move up" onclick="moveCategory(${index}, -1)" ${index === 0 ? 'disabled' : ''}>&uarr;</button>
        <button class="move-arrow-btn" aria-label="Move down" title="Move down" onclick="moveCategory(${index}, 1)" ${index === total - 1 ? 'disabled' : ''}>&darr;</button>
      </div>
      <div style="flex:1;">
        <div class="category-header">
          <div class="category-title">${category.name}</div>
          <div class="category-budget" id="categoryBudget-${index}">Budget: $${category.budget.toFixed(2)}</div>
          <button class="delete-category-btn" title="Delete category" onclick="deleteCategory(${index})">&#128465;</button>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar" id="progressBar-${index}"></div>
        </div>
        <div class="category-footer">
          <div>
            <span id="categorySpent-${index}">Spent: $${category.spent.toFixed(2)}</span>
            <span class="remaining-balance" id="categoryBalance-${index}"></span>
            <span class="overspent" id="categoryOverspent-${index}"></span>
          </div>
          <button class="add-transaction-btn" title="Add transaction" onclick="addTransaction(${index})">+</button>
        </div>
      </div>
    </div>
  `;
  setTimeout(() => {
    updateCategoryBalance(index);
    updateCategoryOverspent(index);
  }, 0);
  return element;
}

function updateProgressBar(index) {
  const budgetData = getBudgetData();
  const category = budgetData[index];
  const progressBar = document.getElementById(`progressBar-${index}`);
  const percentage = (category.spent / category.budget) * 100;

  progressBar.style.width = `${Math.min(percentage, 100)}%`;

  if (percentage > 100) {
    progressBar.classList.add('over-budget');
  } else {
    progressBar.classList.remove('over-budget');
  }
}

function updateCategoryBalance(index) {
  const budgetData = getBudgetData();
  const category = budgetData[index];
  const balanceElement = document.getElementById(`categoryBalance-${index}`);
  const remaining = category.budget - category.spent;
  if (remaining >= 0) {
    balanceElement.textContent = ` | Remaining: $${remaining.toFixed(2)}`;
    balanceElement.style.display = '';
  } else {
    balanceElement.textContent = '';
    balanceElement.style.display = 'none';
  }
}

function updateCategoryOverspent(index) {
  const budgetData = getBudgetData();
  const category = budgetData[index];
  const overspentElement = document.getElementById(`categoryOverspent-${index}`);
  const over = category.spent - category.budget;
  if (over > 0) {
    overspentElement.textContent = ` | Overspent: $${over.toFixed(2)}`;
    overspentElement.style.display = '';
  } else {
    overspentElement.textContent = '';
    overspentElement.style.display = 'none';
  }
}

function getSummaryData() {
  const data = getBudgetData();
  let totalBudget = 0;
  let totalSpent = 0;
  let totalOverspent = 0;
  data.forEach(cat => {
    totalBudget += cat.budget || 0;
    totalSpent += cat.spent || 0;
    if ((cat.spent || 0) > (cat.budget || 0)) {
      totalOverspent += (cat.spent - cat.budget);
    }
  });
  return {
    totalBudget,
    totalSpent,
    totalOverspent
  };
}

function updateSummary() {
  const { totalBudget, totalSpent, totalOverspent } = getSummaryData();
  const summaryDiv = document.getElementById('summary');
  summaryDiv.innerHTML = `
    <span class="summary-budget">Total Budget: $${totalBudget.toFixed(2)}</span>
    <span class="summary-spent">Total Spending: $${totalSpent.toFixed(2)}</span>
    <span class="summary-over">Total Overspent: $${totalOverspent.toFixed(2)}</span>
  `;
}

function downloadBudgetData() {
  const data = getBudgetData();
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "budget_data.json";
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    URL.revokeObjectURL(a.href);
    a.remove();
  }, 0);
}

function downloadBudgetPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const data = getBudgetData();
  let y = 15;

  doc.setFontSize(18);
  doc.text("Budget Tracker Data", 10, y);
  y += 10;
  doc.setFontSize(12);

  if (data.length === 0) {
    doc.text("No budget categories.", 10, y);
  } else {
    let total = 0;
    let totalBudget = 0;
    let totalOverspent = 0;
    data.forEach((cat, i) => {
      doc.text(`${i + 1}. ${cat.name}`, 10, y);
      y += 8;
      doc.text(`Budget: $${cat.budget.toFixed(2)}`, 14, y);
      y += 6;
      doc.text(`Spent: $${cat.spent.toFixed(2)}`, 14, y);
      total += cat.spent;
      totalBudget += cat.budget;
      if (cat.spent <= cat.budget) {
        y += 6;
        doc.text(`Remaining: $${(cat.budget - cat.spent).toFixed(2)}`, 14, y);
      } else {
        y += 6;
        doc.text(`Overspent: $${(cat.spent - cat.budget).toFixed(2)}`, 14, y);
        totalOverspent += (cat.spent - cat.budget);
      }
      y += 3;
      if (y > 270 && i !== data.length - 1) {
        doc.addPage();
        y = 15;
      }
    });
    y += 7;
    doc.setFont(undefined, 'bold');
    doc.text(`Summary:`, 10, y);
    y += 7;
    doc.setFont(undefined, 'normal');
    doc.text(`Total Budget: $${totalBudget.toFixed(2)}`, 14, y);
    y += 6;
    doc.text(`Total Spending: $${total.toFixed(2)}`, 14, y);
    y += 6;
    doc.text(`Total Overspent: $${totalOverspent.toFixed(2)}`, 14, y);
  }

  doc.save("budget_data.pdf");
}

function resetAllBudgets() {
  if (confirm("Reset all budgets? This will set all spent amounts to $0.")) {
    const budgetData = getBudgetData();
    budgetData.forEach(cat => { cat.spent = 0; });
    saveBudgetData(budgetData);
    loadBudgetData();
  }
}

function removeAllCategories() {
  if (confirm("Remove all categories? This will delete all your budget data!")) {
    saveBudgetData([]);
    loadBudgetData();
  }
}

// DRAG AND DROP SORTING (desktop)
function enableDragAndDrop() {
  const container = document.getElementById('categoriesList');
  let draggedElem = null;
  let dragStartIndex = null;

  Array.from(container.children).forEach((card, idx) => {
    card.draggable = true;

    card.ondragstart = function(e) {
      draggedElem = card;
      dragStartIndex = idx;
      setTimeout(() => card.classList.add('dragging'), 0);
      e.dataTransfer.effectAllowed = "move";
    };

    card.ondragend = function() {
      draggedElem = null;
      dragStartIndex = null;
      card.classList.remove('dragging');
      Array.from(container.children).forEach(c => c.classList.remove('drag-over'));
    };

    card.ondragover = function(e) {
      e.preventDefault();
      if (draggedElem && card !== draggedElem) {
        card.classList.add('drag-over');
      }
    };

    card.ondragleave = function() {
      card.classList.remove('drag-over');
    };

    card.ondrop = function(e) {
      e.preventDefault();
      card.classList.remove('drag-over');
      if (draggedElem && card !== draggedElem) {
        const cards = Array.from(container.children);
        const dropIndex = cards.indexOf(card);
        reorderCategories(dragStartIndex, dropIndex);
        loadBudgetData();
      }
    };
  });
}

function reorderCategories(from, to) {
  if (from === to) return;
  const data = getBudgetData();
  const moved = data.splice(from, 1)[0];
  data.splice(to, 0, moved);
  saveBudgetData(data);
}

// Make moveCategory globally accessible (for arrow buttons)
window.moveCategory = moveCategory;
window.deleteCategory = deleteCategory;
window.addTransaction = addTransaction;
</script>
<style>
.category-select {
  width: 100%;
  max-width: 600px;
  margin: 20px auto;
  padding: 10px;
  font-size: 1rem;
  border-radius: var(--border-radius);
  border: 1px solid #ccc;
}

.transactions-list {
  display: none;
  margin-top: 10px;
  padding: 10px;
  background: #f9f9f9;
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
}

.transaction-item {
  display: flex;
  justify-content: space-between;
  padding: 8px;
  border-bottom: 1px solid #eee;
}

.transaction-item:last-child {
  border-bottom: none;
}

.transaction-date {
  color: #666;
  font-size: 0.9rem;
}

.transaction-amount {
  font-weight: bold;
}

.transaction-memo {
  color: #444;
  font-style: italic;
}
</style>

<script>
function createTransactionsList() {
  const categoriesList = document.getElementById('categoriesList');
  const select = document.createElement('select');
  select.className = 'category-select';
  select.innerHTML = '<option value="">Select a category to view transactions</option>';
  
  const transactionsList = document.createElement('div');
  transactionsList.className = 'transactions-list';
  
  const updateTransactionsList = () => {
    const budgetData = getBudgetData();
    const selectedIndex = select.value;
    if (selectedIndex === '') {
      transactionsList.style.display = 'none';
      return;
    }

    const category = budgetData[selectedIndex];
    if (!category.transactions || category.transactions.length === 0) {
      transactionsList.innerHTML = '<p>No transactions found for this category.</p>';
    } else {
      const transactionsHTML = category.transactions
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .map(t => `
          <div class="transaction-item">
            <div>
              <span class="transaction-date">${new Date(t.date).toLocaleDateString()}</span>
              ${t.memo ? `<span class="transaction-memo"> - ${t.memo}</span>` : ''}
            </div>
            <span class="transaction-amount">$${t.amount.toFixed(2)}</span>
          </div>
        `).join('');
      transactionsList.innerHTML = transactionsHTML;
    }
    transactionsList.style.display = 'block';
  };

  const budgetData = getBudgetData();
  budgetData.forEach((category, index) => {
    select.innerHTML += `<option value="${index}">${category.name}</option>`;
  });

  select.addEventListener('change', updateTransactionsList);

  categoriesList.parentNode.insertBefore(select, categoriesList);
  categoriesList.parentNode.insertBefore(transactionsList, categoriesList);
}

document.addEventListener('DOMContentLoaded', () => {
  createTransactionsList();
  // Refresh transactions list whenever budget data changes
  window.addEventListener('storage', createTransactionsList);
});
</script>
</body>
</html>
